---
import { getImage, Image } from "astro:assets";
import Layout from "../layouts/Layout.astro";
import type { ImageMetadata } from "astro";
import { Masonry } from "astro-masonry";
import ImageModal from "../components/ImageModal.astro";
import { setupExifData, type DataTypes } from "@/functions/exifdata";

const listOfFireworks = import.meta.glob<{ default: ImageMetadata }>("/src/assets/fireworks-images/*.jpeg", { eager: true });

const mapping = Object.entries(listOfFireworks).map<Promise<DataTypes>>(setupExifData);

const listing = await Promise.all(mapping);
---

<Layout>
	<h3 class='text-4xl font-bold text-center p-4'>Disney Fireworks by Jesse Slomowitz</h3>

	<Masonry
		sortByHeight={true}
		breakpointCols={{
			default: 4,
			1100: 3,
			700: 2,
			500: 1,
		}}>
		{
			listing.map(async ({ image_data, googleMapsSrc, date, imageElementInput }, index) => {
				return (
					<div id='image-container'>
						<button id='show-dialog-button' class='btn btn-xs' data-GPSSrc={googleMapsSrc} data-date={date} data-index={index}>
							See Image
						</button>
						<div id='index' class='badge'>
							{index + 1}
						</div>
						<Image src={image_data} alt='Fireworks' id='mason-image' id={`mason-image-${index}`} />
					</div>
				);
			})
		}
		<ImageModal />
	</Masonry>
</Layout>

<style lang='scss'>
	:global(.astro-masonry-grid) {
		/* Your custom styles */
		/* You will need to add display: flex */
		gap: 0.5rem;
		padding: 3rem;
	}

	:global(.astro-masonry-grid_column) {
		/* Your custom column styles */
		display: flex;
		flex-direction: column;
		gap: 1rem;
		justify-content: space-between;
	}

	#image-container {
		position: relative;
		overflow: hidden;
		border-radius: 10px;
		border: 1px solid rgba(217, 215, 215, 0.844);

		#mason-image:hover {
			transform: scale(1.1);
			transition: transform 0.5s;
		}
	}

	#index {
		position: absolute;
		top: 1%;
		left: 1%;
		z-index: 2;
	}

	button {
		position: absolute;
		top: 1%;
		right: 1%;
		z-index: 2;
	}

	dialog {
		background-color: rgba(0, 0, 0, 0.8);
		border: none;
		border-radius: 0.5rem;
		overflow: visible;
		scroll: auto;
	}

	#dialog-content {
		scrollbar-width: none;
	}
</style>

<script>
	import constructModalImage from "@/functions/constructModalImage";

	const dialog = document.querySelector<HTMLDialogElement>("dialog");
	const showDialogButton = document.querySelectorAll<HTMLButtonElement>("#show-dialog-button");
	const iframe = dialog?.querySelector("iframe");
	const date = dialog?.querySelector<HTMLDivElement>("#date");

	showDialogButton.forEach(button => constructModalImage(dialog, iframe, date, button));
</script>
